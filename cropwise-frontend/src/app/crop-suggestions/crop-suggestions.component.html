<app-navbar></app-navbar>

<div class="suggestions-container">
  <h2>Crop Suggestions</h2>
  
  <div class="farm-selection-section" *ngIf="farms.length > 0">
      <h3>Select a Farm</h3>
      <div class="farms-grid">
          <div *ngFor="let farm of farms" class="farm-card" [class.selected]="selectedFarm?.id === farm.id" (click)="selectFarm(farm)">
              <h4>{{ farm.farmName }}</h4>
              <div class="farm-details">
                  <p><strong>Size:</strong> {{ farm.farmSize }} acres</p>
                  <p><strong>Location:</strong> {{ farm.location }}</p>
                  <p><strong>Soil Type:</strong> {{ farm.soilType }}</p>
              </div>
          </div>
      </div>
  </div>
  
  <div *ngIf="farms.length === 0 && !loading" class="no-farms-message">
      <p>No farms found. Please add farm details first.</p>
      <button (click)="navigateToFarmForm()" class="secondary-btn">Add Farm Details</button>
  </div>
  
  <div *ngIf="selectedFarm && !loading && !showCropCountSelector" class="suggestion-actions">
      <button (click)="showCropCountSelection()" class="get-suggestions-btn" [disabled]="loading">
          {{ hasSavedSuggestions ? 'Generate New Suggestions' : 'Get Crop Suggestions' }}
      </button>
      <p *ngIf="hasSavedSuggestions" class="last-updated">
          Last updated: {{ lastUpdated | date:'medium' }}
      </p>
  </div>
  
  <!-- Crop Count Selector -->
  <div *ngIf="showCropCountSelector" class="crop-count-selector">
      <h3>How many crops would you like to grow?</h3>
      <p>Enter the number of crops you want to grow on your farm. We'll suggest the best combinations.</p>
      
      <div class="crop-count-input">
          <div class="form-group">
              <label for="cropCount">Number of Crops:</label>
              <input 
                  type="number" 
                  id="cropCount" 
                  [(ngModel)]="customCropCount" 
                  min="1" 
                  max="10"
                  class="crop-count-field"
                  placeholder="Enter number (1-10)"
              >
          </div>
          
          <p class="input-helper-text">
              Enter a number between 1 and 10. Most farmers typically grow 2-3 crops.
          </p>
      </div>
      
      <div class="crop-count-actions">
          <button class="secondary-btn" (click)="cancelCropCountSelection()">Cancel</button>
          <button class="get-suggestions-btn" (click)="getSuggestions()" [disabled]="!customCropCount || customCropCount < 1">
              Get Suggestions
          </button>
      </div>
  </div>
  
  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>
  
  <div *ngIf="loading" class="loading">
    <p>Analyzing your farm data and local weather conditions...</p>
    <div class="spinner"></div>
  </div>
  
  <div *ngIf="weatherData && !loading" class="weather-data">
    <h3>Current Weather Conditions</h3>
    <div class="weather-grid">
      <div class="weather-item">
        <span class="label">Temperature:</span>
        <span class="value">{{ weatherData.temperature }}Â°C</span>
      </div>
      <div class="weather-item">
        <span class="label">Rainfall:</span>
        <span class="value">{{ weatherData.rainfall }} mm</span>
      </div>
      <div class="weather-item">
        <span class="label">Humidity:</span>
        <span class="value">{{ weatherData.humidity }}%</span>
      </div>
      <div class="weather-item">
        <span class="label">Season:</span>
        <span class="value">{{ weatherData.season }}</span>
      </div>
      <div *ngIf="weatherData.forecast" class="weather-item">
        <span class="label">Forecast:</span>
        <span class="value">{{ weatherData.forecast }}</span>
      </div>
    </div>
  </div>
  
  <!-- Crop Combinations Section (for multiple crops) -->
  <div *ngIf="(cropCombinations).length > 0 && selectedCropCount && selectedCropCount > 1 && !loading" class="crop-combinations">
    <h3>Recommended Crop Combinations</h3>
    
    <div *ngFor="let combination of cropCombinations; let i = index" class="combination-card">
      <div class="combination-header">
        <h4>Combination {{ i + 1 }}</h4>
        <div class="compatibility-score" [style.background-color]="getCompatibilityColor(combination.compatibilityScore)">
          {{ combination.compatibilityScore }}% Compatible
        </div>
      </div>
      
      <div class="combination-crops">
        <div *ngFor="let crop of combination.crops" class="combination-crop">
          <div class="crop-name">{{ crop.cropName }}</div>
          <div class="crop-percentage">{{ crop.percentage }}% of farm</div>
          <div class="crop-area">{{ calculateArea(crop.percentage) }} acres</div>
        </div>
      </div>
      
      <div class="combination-details">
        <div class="detail-item">
          <span class="label">Why These Crops Work Together:</span>
          <ul>
            <li *ngFor="let reason of combination.compatibilityReasons">{{ reason }}</li>
          </ul>
        </div>
        
        <div class="detail-item">
          <span class="label">Planting Sequence:</span>
          <p>{{ combination.plantingSequence }}</p>
        </div>
        
        <div class="detail-item">
          <span class="label">Crop Rotation Benefits:</span>
          <p>{{ combination.rotationBenefits }}</p>
        </div>
        
        <div *ngIf="combination.additionalNotes" class="detail-item notes">
          <span class="label">Additional Notes:</span>
          <p>{{ combination.additionalNotes }}</p>
        </div>
      </div>
    </div>
  </div>
  
  <div *ngIf="suggestions.length > 0 && !loading" class="suggestions-list">
    <h3>Recommended Crops</h3>
    
    <div *ngFor="let suggestion of suggestions" class="suggestion-card">
      <div class="suggestion-header">
        <h4>{{ suggestion.cropName }}</h4>
        <div class="confidence" [style.background-color]="getConfidenceColor(suggestion.confidence)">
          {{ suggestion.confidence }}% Confidence
        </div>
      </div>
      
      <div class="suggestion-details">
        <div class="detail-item">
          <span class="label">Reasons for Selection:</span>
          <ul>
            <li *ngFor="let reason of suggestion.reasonsForSelection">{{ reason }}</li>
          </ul>
        </div>
        
        <div class="detail-item">
          <span class="label">Planting Time:</span>
          <span class="value">{{ suggestion.plantingTime }}</span>
        </div>
        
        <div class="detail-item">
          <span class="label">Harvest Time:</span>
          <span class="value">{{ suggestion.harvestTime }}</span>
        </div>
        
        <div class="detail-item">
          <span class="label">Time to Harvest:</span>
          <span class="value">{{ suggestion.timeToHarvest }}</span>
        </div>
        
        <div class="detail-item">
          <span class="label">Expected Yield:</span>
          <span class="value">{{ suggestion.expectedYield }}</span>
        </div>
        
        <div class="detail-item">
          <span class="label">Capital Required:</span>
          <span class="value">{{ suggestion.capitalRequired }}</span>
        </div>
        
        <div class="detail-item">
          <span class="label">Water Requirements:</span>
          <span class="value">{{ suggestion.waterRequirements }}</span>
        </div>
        
        <div class="detail-item">
          <span class="label">Recommended Fertilizers:</span>
          <ul>
            <li *ngFor="let fertilizer of suggestion.fertilizers">{{ fertilizer }}</li>
          </ul>
        </div>
        
        <div class="detail-item">
          <span class="label">Pest Management:</span>
          <ul>
            <li *ngFor="let pest of suggestion.pestManagement">{{ pest }}</li>
          </ul>
        </div>
        
        <div *ngIf="suggestion.additionalNotes" class="detail-item notes">
          <span class="label">Additional Notes:</span>
          <p>{{ suggestion.additionalNotes }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Chatbot -->
<div class="chatbot-wrapper" [class.open]="isChatbotOpen">
  <!-- Chatbot Icon -->
  <div class="chatbot-icon" (click)="toggleChatbot()" *ngIf="!isChatbotOpen">
    <div class="icon-inner">
      <span class="chat-icon">ðŸ’¬</span>
      <span *ngIf="unreadMessages > 0" class="unread-badge">{{ unreadMessages }}</span>
    </div>
  </div>
  
  <!-- Chatbot Panel -->
  <div class="chatbot-panel" *ngIf="isChatbotOpen">
    <div class="pull-indicator"></div>
    <div class="chatbot-header">
      <h3>CropWise Assistant</h3>
      <div class="chatbot-controls">
        <button class="close-btn" (click)="toggleChatbot()">âœ•</button>
      </div>
    </div>
    
    <div class="chatbot-body">
      <div class="chat-messages" #chatMessages>
        <div *ngFor="let message of getCurrentFarmChatHistory()" class="message" [ngClass]="{'user-message': message.sender === 'user', 'bot-message': message.sender === 'bot'}">
          <div class="message-content">
            <p [innerHTML]="message.text | formatMessage"></p>
          </div>
          <div class="message-time">{{ message.timestamp | date:'shortTime' }}</div>
        </div>
        
        <div *ngIf="isChatLoading" class="bot-message loading-message">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      </div>
      
      <div class="chat-input">
        <input 
          type="text" 
          [(ngModel)]="currentMessage" 
          placeholder="Ask about your crop suggestions..." 
          (keyup.enter)="sendMessage()"
          [disabled]="isChatLoading"
        >
        <button 
          class="send-btn" 
          (click)="sendMessage()" 
          [disabled]="!currentMessage.trim() || isChatLoading"
        >
          <span class="send-icon">âž¤</span>
        </button>
      </div>
      
      <div class="chat-suggestions">
        <p>Suggested questions:</p>
        <div class="suggestion-chips">
          <button *ngFor="let question of suggestedQuestions" class="suggestion-chip" (click)="useQuestion(question)">
            {{ question }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
